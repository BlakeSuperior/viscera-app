# VISCERA Mobile App Database Schema

## Overview
This document outlines the database schema for the VISCERA mobile application. The schema is designed to support the four key systems (Chamber, Profiler Engine, Library, and Construct) while enabling efficient data storage, retrieval, and analysis.

## Database Technology
- Primary Database: MongoDB (NoSQL)
- Local Storage: IndexedDB (for offline functionality)
- Caching Layer: Redis (for performance optimization)

## Collections/Tables

### 1. Users
```
{
  _id: ObjectId,
  username: String,           // Optional display name
  email: String,              // Optional, for account recovery
  passwordHash: String,       // Securely stored if account system used
  createdAt: Date,
  lastActive: Date,
  settings: {
    privacy: {
      anonymized: Boolean,    // Whether profile is anonymized
      dataStorage: String,    // "local", "cloud", or "hybrid"
      sharingEnabled: Boolean // Whether insights can be shared
    },
    display: {
      textSize: Number,
      textSpeed: Number,
      darkModeVariant: String,
      hapticIntensity: Number
    },
    audio: {
      masterVolume: Number,
      ambientVolume: Number,
      effectsVolume: Number,
      muted: Boolean
    },
    accessibility: {
      highContrast: Boolean,
      reducedMotion: Boolean,
      screenReaderOptimized: Boolean
    }
  },
  onboardingCompleted: Boolean
}
```

### 2. Simulations
```
{
  _id: ObjectId,
  title: String,
  simulationNumber: String,   // e.g., "001", "002"
  description: String,        // Non-spoiler description
  category: [String],         // Psychological domains
  complexity: Number,         // 1-5 scale
  estimatedDuration: Number,  // In minutes
  tags: [String],
  content: {
    initialSetup: String,     // Opening narrative
    branches: [               // Possible narrative paths
      {
        id: String,
        condition: String,    // Trigger condition
        text: String,         // Narrative text
        nextBranches: [String] // IDs of possible next branches
      }
    ],
    endings: [                // Possible conclusions
      {
        id: String,
        condition: String,
        text: String
      }
    ]
  },
  analysisParameters: {       // Guides for the Profiler Engine
    traits: [String],         // Traits being tested
    contradictions: [String], // Potential contradictions to watch for
    narrativeRoles: [String]  // Possible roles user might assume
  },
  createdAt: Date,
  updatedAt: Date,
  active: Boolean             // Whether simulation is available
}
```

### 3. UserSimulations
```
{
  _id: ObjectId,
  userId: ObjectId,           // Reference to Users
  simulationId: ObjectId,     // Reference to Simulations
  startedAt: Date,
  completedAt: Date,
  status: String,             // "in-progress", "completed", "abandoned"
  interactions: [
    {
      timestamp: Date,
      narrativeText: String,  // System prompt
      userResponse: String,   // User's response
      branchId: String        // Reference to branch in Simulation
    }
  ],
  userNotes: String,          // Personal annotations
  analysis: {                 // Generated by Profiler Engine
    decisionsummary: String,
    narrativeReflex: String,
    latentTraits: [
      {
        trait: String,
        score: Number,        // -10 to 10 scale
        evidence: String      // Justification from responses
      }
    ],
    contradictions: [
      {
        description: String,
        severity: Number,     // 1-5 scale
        evidence: [String]    // References to responses
      }
    ],
    instruments: [
      {
        element: String,      // Test element
        purpose: String,      // Psychological purpose
        userResponse: String  // How user reacted
      }
    ],
    reflection: String        // Final analysis statement
  },
  profileImpact: {            // How this simulation affected the Construct
    traitChanges: [
      {
        trait: String,
        previousValue: Number,
        newValue: Number,
        magnitude: Number     // Significance of change
      }
    ],
    newContradictions: [String],
    resolvedContradictions: [String],
    narrativeShift: {
      from: String,
      to: String,
      significance: Number
    }
  }
}
```

### 4. UserProfiles
```
{
  _id: ObjectId,
  userId: ObjectId,           // Reference to Users
  version: Number,            // Incremented with each update
  createdAt: Date,
  updatedAt: Date,
  traits: [
    {
      category: String,       // Trait category
      name: String,           // Specific trait
      value: Number,          // -10 to 10 scale
      confidence: Number,     // 0-1 scale
      history: [
        {
          value: Number,
          timestamp: Date,
          simulationId: ObjectId // Reference to triggering simulation
        }
      ]
    }
  ],
  contradictions: [
    {
      description: String,
      firstDetected: Date,
      lastConfirmed: Date,
      frequency: Number,      // How often observed
      relatedTraits: [String],
      status: String          // "active", "resolved", "fluctuating"
    }
  ],
  narrativeRoles: [
    {
      role: String,           // e.g., "Hero", "Ghost", "Martyr"
      frequency: Number,      // 0-1 scale
      contexts: [String],     // When this role emerges
      firstObserved: Date,
      lastObserved: Date
    }
  ],
  psychometricSummary: {      // Overall profile characteristics
    moralFlexibility: Number,
    empathicRange: Number,
    cognitiveConsistency: Number,
    selfAwareness: Number,
    decisionConfidence: Number
  },
  evolutionMetrics: {         // How profile has changed over time
    stabilityIndex: Number,   // 0-1 scale
    growthVector: String,     // Direction of change
    significantShifts: [
      {
        description: String,
        timestamp: Date,
        simulationId: ObjectId
      }
    ]
  }
}
```

### 5. ProfileSnapshots
```
{
  _id: ObjectId,
  userId: ObjectId,           // Reference to Users
  profileId: ObjectId,        // Reference to UserProfiles
  timestamp: Date,
  reason: String,             // Why snapshot was taken
  snapshotData: Object        // Complete copy of profile at point in time
}
```

### 6. AnalysisCache
```
{
  _id: ObjectId,
  userId: ObjectId,
  simulationId: ObjectId,
  responseHash: String,       // Hash of user responses
  analysisResult: Object,     // Cached analysis
  createdAt: Date,
  expiresAt: Date             // TTL for cache entry
}
```

## Relationships

1. **User to UserSimulations**: One-to-Many
   - A user can have multiple simulation sessions

2. **User to UserProfile**: One-to-One
   - Each user has exactly one current profile

3. **User to ProfileSnapshots**: One-to-Many
   - A user can have multiple historical profile snapshots

4. **Simulation to UserSimulations**: One-to-Many
   - A simulation template can be used in multiple user sessions

5. **UserSimulations to UserProfile**: Many-to-One
   - Multiple simulation sessions contribute to a single user profile

## Indexing Strategy

### Users Collection
- `_id`: Primary index
- `email`: Secondary index for lookup
- `lastActive`: Index for activity queries

### Simulations Collection
- `_id`: Primary index
- `category`: Index for filtering
- `tags`: Index for filtering
- `complexity`: Index for sorting

### UserSimulations Collection
- `_id`: Primary index
- `userId`: Index for user's history
- `simulationId`: Index for simulation statistics
- `completedAt`: Index for chronological queries
- Compound index on `userId` and `status` for active sessions

### UserProfiles Collection
- `_id`: Primary index
- `userId`: Unique index
- `updatedAt`: Index for recent changes

### ProfileSnapshots Collection
- `_id`: Primary index
- `userId`: Index for user's snapshots
- `timestamp`: Index for chronological queries

### AnalysisCache Collection
- `_id`: Primary index
- Compound index on `userId` and `simulationId`
- `responseHash`: Index for cache hits
- `expiresAt`: TTL index for automatic expiration

## Data Migration and Versioning

- Schema version field in each collection
- Migration scripts for schema updates
- Backward compatibility layers for older app versions

## Offline Synchronization

- Priority queue for sync operations
- Conflict resolution strategies:
  - Server-wins for critical data
  - Last-write-wins for user preferences
  - Merge strategy for non-conflicting profile updates

## Data Retention and Privacy

- Configurable retention periods
- Data anonymization pipeline
- Export functionality for user data portability
- Secure deletion process for account termination
